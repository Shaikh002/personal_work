name: 📤 Upload Reels to YouTube

on: 
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  upload:
    runs-on: ubuntu-latest

    env:
      INSTAGRAM_PROFILE: Hacksnip
      UPLOAD_LIMIT: 1
      IG_COOKIES_JSON: ${{ secrets.IG_COOKIES_JSON }}
      YT_TOKEN_JSON_B64: ${{ secrets.YT_TOKEN_JSON_B64 }}
      CLIENT_SECRETS_B64: ${{ secrets.CLIENT_SECRETS_B64 }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: ⬇️ Checkout repository
        uses: actions/checkout@v4

      - name: 📥 Download processed reels from last run
        uses: actions/download-artifact@v4
        with:
          name: processed-reels
          path: .
        continue-on-error: true

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: 🔐 Restore OAuth secrets
        run: |
          if [ -z "$YT_TOKEN_JSON_B64" ]; then
            echo "❌ Missing YT_TOKEN_JSON_B64 secret" >&2
            exit 1
          fi
          if [ -z "$CLIENT_SECRETS_B64" ]; then
            echo "❌ Missing CLIENT_SECRETS_B64 secret" >&2
            exit 1
          fi
          echo "$YT_TOKEN_JSON_B64" | base64 --decode > token.json
          echo "$CLIENT_SECRETS_B64" | base64 --decode > client_secrets.json
          echo "✅ Restored OAuth files"

      - name: 🚀 Run auto_reels_to_youtube.py
        run: |
          xvfb-run --auto-servernum --server-args='-screen 0 1280x720x24' \
            python auto_reels_to_youtube.py

      - name: 🐛 Debug output
        run: |
          echo "=== Debug Artifacts ==="
          ls -la debug_reels_error.png || true
          echo "--- processed_reels.json ---"
          cat processed_reels.json || true

      - name: 📤 Upload processed_reels.json as artifact
        uses: actions/upload-artifact@v4
        with:
          name: processed-reels
          path: processed_reels.json

      - name: 📸 Upload debug screenshot if exists
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshot
          path: debug_reels_error.png
        if: always()
