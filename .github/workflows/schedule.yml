name: Upload IG Reel to YouTube

on:
  schedule:
    - cron: '0 */6 * * *'  # every 6 hours
  workflow_dispatch:

jobs:
  upload_reel:
    runs-on: ubuntu-latest
    env:
      INSTAGRAM_PROFILE: Hacksnip
      UPLOAD_LIMIT: 1
      IG_COOKIES_JSON: ${{ secrets.IG_COOKIES_JSON }}
      YT_TOKEN_JSON_B64: ${{ secrets.YT_TOKEN_JSON_B64 }}
      CLIENT_SECRETS_B64: ${{ secrets.CLIENT_SECRETS_B64 }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ§± Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libnss3 libatk-bridge2.0-0 libxss1 xvfb unzip jq

      - name: ğŸ“¦ Install Python dependencies & Playwright
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install requests yt-dlp google-api-python-client google-auth google-auth-oauthlib playwright openai
          playwright install --with-deps

      - name: ğŸ”‘ Restore YouTube credentials and client secrets
        run: |
          if [ -z "${YT_TOKEN_JSON_B64}" ]; then
            echo "âŒ Missing YT_TOKEN_JSON_B64 secret" >&2
            exit 1
          fi
          if [ -z "${CLIENT_SECRETS_B64}" ]; then
            echo "âŒ Missing CLIENT_SECRETS_B64 secret" >&2
            exit 1
          fi
          echo "${YT_TOKEN_JSON_B64}" | base64 --decode > token.json
          echo "${CLIENT_SECRETS_B64}" | base64 --decode > client_secrets.json
          echo "âœ… Restored OAuth files"

      - name: â–¶ï¸ Run upload script in virtual display
        run: |
          xvfb-run --auto-servernum --server-args='-screen 0 1280x720x24' \
            python auto_reels_to_youtube.py
      - name: ğŸ” Commit processed_reels.json
        run: |
         git config user.name "github-actions[bot]"
         git config user.email "github-actions[bot]@users.noreply.github.com"
         git pull --rebase
         git add processed_reels.json || true
         git diff --cached --quiet || git commit -m "ğŸ” Update processed reels log"
         git push https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}.git HEAD:main || echo "âš ï¸ Nothing new to push"
        env:
           GH_PAT: ${{ secrets.GH_PAT }}

      - name: ğŸ§¾ Dump debug if failure
        if: failure()
        run: |
          echo "=== Debug Artifacts ==="
          ls -la debug_reels_error.png || true
          echo "--- processed_reels.json ---"
          cat processed_reels.json || true
